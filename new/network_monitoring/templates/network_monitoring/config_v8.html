<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Monitoring Configuration</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #2c3e50;
            color: #ecf0f1;
            margin: 0;
            padding: 0;
        }

        nav {
            background: #1a252f;
            color: #ecf0f1;
            padding: 15px;
            text-align: center;
            font-size: 20px;
            font-weight: bold;
        }

        .content {
            width: 90%;
            margin: 20px auto;
            padding: 20px;
        }

        .section-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .section {
            flex: 1;
            padding: 15px;
            background: #34495e;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .left-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .right-column {
            flex: 1;
        }

        .section-title {
            font-size: 18px;
            margin-bottom: 15px;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: #34495e;
            color: #ecf0f1;
            border-radius: 8px;
        }

        td,
        th {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #7f8c8d;
        }

        th {
            background: #1a252f;
        }

        input {
            width: 95%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #ecf0f1;
            color: #2c3e50;
        }

        button {
            background: #2980b9;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
        }

        button:hover {
            background: #1c5985;
        }

        #saveButton {
            width: 200px;
            margin: 20px auto;
            display: block;
        }

        #message {
            margin-top: 10px;
            color: #2ecc71;
            font-weight: bold;
            text-align: center;
        }

        .status-container {
            margin-top: 20px;
        }

        .status {
            padding: 15px;
            background: #34495e;
            border-radius: 8px;
        }

        .status h3 {
            margin-top: 0;
            border-bottom: 1px solid #7f8c8d;
            padding-bottom: 8px;
        }

        .ip-container {
            margin-bottom: 10px;
        }

        .ip-entry {
            display: flex;
            margin-bottom: 10px;
            align-items: center;
            padding: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
        }

        .ip-entry select {
            width: 100px;
            padding: 10px;
            margin-right: 10px;
            border: 1px solid #7f8c8d;
            border-radius: 4px;
            background: #ecf0f1;
            color: #2c3e50;
        }

        .ip-entry input {
            flex-grow: 1;
            margin-right: 10px;
        }

        .remove-ip {
            background: #95a5a6;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 12px;
            cursor: pointer;
            margin-top: 0;
        }

        .remove-ip:hover {
            background: #7f8c8d;
        }

        .add-ip {
            background: #27ae60;
            color: white;
            padding: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            width: auto;
        }

        .lte-header {
            font-weight: bold;
            background-color: #1a252f;
            text-align: center;
        }

        .separator {
            height: 10px;
            background-color: transparent;
        }

        @media (max-width: 768px) {
            .section-container {
                flex-direction: column;
            }

            #saveButton {
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <nav>
        Network Monitoring - Configuration
    </nav>
    <div class="content">
        <form id="configForm">
            {% csrf_token %}

            <div class="section-container">
                <div class="left-column">
                    <div class="section">
                        <div class="section-title">LQI Parameters</div>
                        <table>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                            </tr>
                            <tr>
                                <td>Sampling Interval (Minutes):</td>
                                <td><input type="number" id="celery_interval" required></td>
                            </tr>
                            <tr>
                                <td>Test Repetition Frequency (z):</td>
                                <td><input type="number" id="test_repetition" required></td>
                            </tr>
                        </table>
                    </div>

                    <div class="section">
                        <div class="section-title">Target IP Addresses</div>
                        <div id="ip-container" class="ip-container">
                            <!-- IP entries will be added here -->
                        </div>
                        <button type="button" class="add-ip" id="add-ip-btn">Add New IP</button>
                    </div>
                </div>

                <div class="right-column">
                    <div class="section">
                        <div class="section-title">Loss Parameters</div>
                        <table>
                            <tr>
                                <th>Parameter</th>
                                <th>Value</th>
                            </tr>
                            <tr>
                                <td>Number of Test Instances (n):</td>
                                <td><input type="number" id="test_instances" required></td>
                            </tr>
                            <tr>
                                <td>Packets per Test (p):</td>
                                <td><input type="number" id="packets_per_test" required></td>
                            </tr>
                            <tr>
                                <td>Time Between Instances (min):</td>
                                <td><input type="number" id="time_between_instances" required></td>
                            </tr>
                            <tr>
                                <td>Loss Threshold % (LT):</td>
                                <td><input type="number" id="loss_threshold" required></td>
                            </tr>
                            <tr>
                                <td>Network Interface:</td>
                                <td><input type="text" id="interface" placeholder="e.g. ens224"></td>
                            </tr>
                        </table>
                    </div>

                    <div class="section">
                        <div class="section-title">Current Status</div>
                        <table>
                            <tr>
                                <td>Last Test:</td>
                                <td id="lastTest">-</td>
                            </tr>
                            <tr>
                                <td>Current Loss:</td>
                                <td id="currentLoss">-</td>
                            </tr>
                            <tr>
                                <td>Latency:</td>
                                <td id="avgLatency">-</td>
                            </tr>
                            <tr>
                                <td>Jitter:</td>
                                <td id="jitter">-</td>
                            </tr>
                            <tr>
                                <td>No data available</td>
                            </tr>

                        </table>
                    </div>
                </div>
            </div>

            <button type="submit" id="saveButton">Save Configuration</button>
        </form>
        <p id="message"></p>

        <script>
            // Load current config when page loads
            document.addEventListener("DOMContentLoaded", function () {
                loadCurrentConfig();
                loadCurrentStatus();
            });

            function loadCurrentConfig() {
                fetch("/network_monitoring/get_config/")
                    .then(response => response.json())
                    .then(data => {
                        if (data.config) {
                            document.getElementById("celery_interval").value = data.config.celery_interval || "";
                            document.getElementById("test_instances").value = data.config.num_test_instances || "";
                            document.getElementById("packets_per_test").value = data.config.packets_per_test || "";
                            document.getElementById("time_between_instances").value = data.config.time_between_instances || "";
                            document.getElementById("test_repetition").value = data.config.test_repetition_frequency || "";
                            document.getElementById("loss_threshold").value = data.config.loss_threshold || "";
                            document.getElementById("interface").value = data.config.interface || "ens224";

                            // Load IP addresses
                            const ipContainer = document.getElementById("ip-container");
                            ipContainer.innerHTML = "";

                            if (data.config.test_ips && Array.isArray(data.config.test_ips)) {
                                data.config.test_ips.forEach(ipEntry => {
                                    addIpEntry(ipEntry.type, ipEntry.ip);
                                });
                            } else {
                                // Backward compatibility for single IP
                                if (data.config.test_ip) {
                                    addIpEntry("LTE1", data.config.test_ip);
                                    addIpEntry("LTE2", "8.8.4.4"); // Default secondary IP
                                } else {
                                    addIpEntry("LTE1", "8.8.8.8");
                                    addIpEntry("LTE2", "8.8.4.4");
                                }
                            }
                        }
                    })
                    .catch(error => console.error("Error loading config:", error));
            } function loadCurrentStatus() {
                fetch("/network_monitoring/current_status/")
                    .then(response => response.json())
                    .then(data => {
                        const statusContainer = document.getElementById("status-container");

                        if (data.status === "success" && data.data) {
                            // Create table to display data for each LTE type
                            let html = '<table>';

                            // Iterate through each LTE type in the data
                            for (const lteType in data.data) {
                                const statusData = data.data[lteType];

                                html += `
                    <tr>
                        <td colspan="2" class="lte-header">${lteType}</td>
                    </tr>
                    <tr>
                        <td>Last Test:</td>
                        <td>${statusData.timestamp || "-"}</td>
                    </tr>
                    <tr>
                        <td>Current Loss:</td>
                        <td>${formatNumericValue(statusData.packet_loss || "-")}</td>
                    </tr>
                    <tr>
                        <td>Latency:</td>
                        <td>${formatNumericValue(statusData.latency || "-")}</td>
                    </tr>
                    <tr>
                        <td>Jitter:</td>
                        <td>${formatNumericValue(statusData.jitter || "-")}</td>
                    </tr>
                    <tr>
                        <td colspan="2" class="separator"></td>
                    </tr>
                `;
                            }

                            html += '</table>';
                            statusContainer.innerHTML = html;
                        } else {
                            statusContainer.innerHTML = '<table><tr><td>No monitoring data available</td></tr></table>';
                        }
                    })
                    .catch(error => {
                        console.error("Error loading status:", error);
                        const statusContainer = document.getElementById("status-container");
                        statusContainer.innerHTML = '<table><tr><td>Error loading data</td></tr></table>';
                    });
            }

            // Format values to 2 decimal places if they are numeric
            function formatNumericValue(value) {
                if (value === "-") return "-";

                // If it ends with %, handle it separately
                if (typeof value === 'string' && value.endsWith('%')) {
                    const numValue = parseFloat(value);
                    if (!isNaN(numValue)) {
                        return numValue.toFixed(2) + '%';
                    }
                }

                const numValue = parseFloat(value);
                if (!isNaN(numValue)) {
                    return numValue.toFixed(2);
                }

                return value;
            }

            function addIpEntry(type = "LTE1", ip = "") {
                const ipContainer = document.getElementById("ip-container");
                const entryDiv = document.createElement("div");
                entryDiv.className = "ip-entry";

                const typeSelect = document.createElement("select");
                typeSelect.className = "ip-type";

                const options = ["LTE1", "LTE2", "LTE3", "LTE4", "Custom"];
                options.forEach(option => {
                    const optElement = document.createElement("option");
                    optElement.value = option;
                    optElement.textContent = option;
                    if (option === type) optElement.selected = true;
                    typeSelect.appendChild(optElement);
                });

                const ipInput = document.createElement("input");
                ipInput.type = "text";
                ipInput.className = "ip-address";
                ipInput.placeholder = "e.g. 8.8.8.8";
                ipInput.value = ip;
                ipInput.required = true;

                const removeBtn = document.createElement("button");
                removeBtn.type = "button";
                removeBtn.className = "remove-ip";
                removeBtn.textContent = "Remove";
                removeBtn.onclick = function () {
                    ipContainer.removeChild(entryDiv);
                };

                entryDiv.appendChild(typeSelect);
                entryDiv.appendChild(ipInput);
                entryDiv.appendChild(removeBtn);

                ipContainer.appendChild(entryDiv);
            }

            // Add IP button event listener
            document.getElementById("add-ip-btn").addEventListener("click", function () {
                addIpEntry();
            });

            document.getElementById("configForm").addEventListener("submit", function (event) {
                event.preventDefault();

                // Collect IP entries
                const ipEntries = document.querySelectorAll(".ip-entry");
                const testIps = Array.from(ipEntries).map(entry => {
                    return {
                        type: entry.querySelector(".ip-type").value,
                        ip: entry.querySelector(".ip-address").value
                    };
                });

                // Ensure we have at least LTE1 and LTE2
                if (testIps.length < 2) {
                    document.getElementById("message").innerText = "Error: At least two IP addresses (LTE1 and LTE2) are required";
                    return;
                }

                let csrfToken = document.querySelector("[name=csrfmiddlewaretoken]").value;
                let requestData = {
                    celery_interval: document.getElementById("celery_interval").value,
                    num_test_instances: document.getElementById("test_instances").value,
                    packets_per_test: document.getElementById("packets_per_test").value,
                    time_between_instances: document.getElementById("time_between_instances").value,
                    test_repetition_frequency: document.getElementById("test_repetition").value,
                    loss_threshold: document.getElementById("loss_threshold").value,
                    interface: document.getElementById("interface").value,
                    test_ips: testIps
                };

                fetch("/network_monitoring/save_config/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken
                    },
                    body: JSON.stringify(requestData)
                })
                    .then(response => response.json())
                    .then(data => {
                        document.getElementById("message").innerText = data.message || data.error;
                        // Reload current status after saving config
                        loadCurrentStatus();
                    })
                    .catch(error => console.error("Error:", error));
            });

            // Refresh status every 30 seconds
            setInterval(loadCurrentStatus, 30000);
        </script>
    </div>
</body>

</html>