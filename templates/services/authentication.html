{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Authentication Configuration{% endblock %}

{% block content %}
<div id="auth-content">
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>Authentication Method</h4>
                </div>
                <div class="card-body">
                    <form id="authMethodForm">
                        <div class="mb-3">
                            <label for="authMethod" class="form-label">Select Method</label>
                            <select class="form-select" id="authMethod" name="method">
                                <option value="local">Local</option>
                                <option value="ldap">LDAP</option>
                                <option value="tacacs">TACACS+</option>
                                <option value="radius">RADIUS</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Method</button>
                    </form>
                </div>
            </div>
            <div class="card mb-4">
                <div class="card-header">
                    <h4>User Privileges</h4>
                </div>
                <div class="card-body">
                    <div id="userPrivilegeTable"></div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card mb-4" id="ldapConfigCard" style="display:none;">
                <div class="card-header"><h4>LDAP Configuration</h4></div>
                <div class="card-body">
                    <form id="ldapConfigForm">
                        <div class="mb-3"><label>Server URI</label><input type="text" class="form-control" name="server_uri"></div>
                        <div class="mb-3"><label>Base DN</label><input type="text" class="form-control" name="base_dn"></div>
                        <div class="mb-3"><label>User DN Template</label><input type="text" class="form-control" name="user_dn_template"></div>
                        <button type="submit" class="btn btn-primary">Save LDAP Config</button>
                    </form>
                </div>
            </div>
            <div class="card mb-4" id="tacacsConfigCard" style="display:none;">
                <div class="card-header"><h4>TACACS+ Configuration</h4></div>
                <div class="card-body">
                    <form id="tacacsConfigForm">
                        <div class="mb-3"><label>Server</label><input type="text" class="form-control" name="server"></div>
                        <div class="mb-3"><label>Port</label><input type="number" class="form-control" name="port"></div>
                        <div class="mb-3"><label>Secret</label><input type="password" class="form-control" name="secret"></div>
                        <button type="submit" class="btn btn-primary">Save TACACS+ Config</button>
                    </form>
                </div>
            </div>
            <div class="card mb-4" id="radiusConfigCard" style="display:none;">
                <div class="card-header"><h4>RADIUS Configuration</h4></div>
                <div class="card-body">
                    <form id="radiusConfigForm">
                        <div class="mb-3"><label>Server</label><input type="text" class="form-control" name="server"></div>
                        <div class="mb-3"><label>Secret</label><input type="password" class="form-control" name="secret"></div>
                        <button type="submit" class="btn btn-primary">Save RADIUS Config</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="not-authorized" style="display:none;">{% include 'not_authorized.html' %}</div>
{% endblock %}

{% block extra_js %}
<script>
function showConfigCard(method) {
    document.getElementById('ldapConfigCard').style.display = (method === 'ldap') ? '' : 'none';
    document.getElementById('tacacsConfigCard').style.display = (method === 'tacacs') ? '' : 'none';
    document.getElementById('radiusConfigCard').style.display = (method === 'radius') ? '' : 'none';
}
function loadAuthConfig() {
    // Always show the authentication page for local users (development mode)
    document.getElementById('auth-content').style.display = '';
    document.getElementById('not-authorized').style.display = 'none';
}
document.addEventListener('DOMContentLoaded', function() {
    // Set method selection and config cards
    document.getElementById('authMethodForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const method = document.getElementById('authMethod').value;
        fetch('/api/auth/set_method/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({method})
        }).then(r => r.json()).then(data => {
            if (data.success) {
                showConfigCard(method);
            }
        });
    });
    document.getElementById('authMethod').addEventListener('change', function() {
        showConfigCard(this.value);
    });
    // LDAP config
    document.getElementById('ldapConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/api/auth/set_ldap/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new FormData(this)
        }).then(r => r.json()).then(data => {
            if (data.success) alert('LDAP config saved');
        });
    });
    // TACACS config
    document.getElementById('tacacsConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/api/auth/set_tacacs/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new FormData(this)
        }).then(r => r.json()).then(data => {
            if (data.success) alert('TACACS+ config saved');
        });
    });
    // RADIUS config
    document.getElementById('radiusConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        fetch('/api/auth/set_radius/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new FormData(this)
        }).then(r => r.json()).then(data => {
            if (data.success) alert('RADIUS config saved');
        });
    });
    // Load user privilege table
    fetch('/api/auth/users/').then(r => r.json()).then(data => {
        fetch('/api/auth/privilege_levels/').then(r2 => r2.json()).then(levelsData => {
            let html = '<table class="table table-striped"><thead><tr><th>User</th><th>Email</th><th>Privilege</th></tr></thead><tbody>';
            data.users.forEach(user => {
                html += `<tr><td>${user.username}</td><td>${user.email}</td><td><select data-user-id="${user.id}" class="privilege-select">`;
                levelsData.levels.forEach(level => {
                    html += `<option value="${level.id}">${level.level}: ${level.name}</option>`;
                });
                html += '</select></td></tr>';
            });
            html += '</tbody></table>';
            document.getElementById('userPrivilegeTable').innerHTML = html;
            document.querySelectorAll('.privilege-select').forEach(sel => {
                sel.addEventListener('change', function() {
                    fetch('/api/auth/set_user_privilege/', {
                        method: 'POST',
                        headers: {'X-CSRFToken': '{{ csrf_token }}'},
                        body: new URLSearchParams({user_id: this.dataset.userId, level_id: this.value})
                    }).then(r => r.json()).then(data => {
                        if (data.success) alert('Privilege updated');
                    });
                });
            });
        });
    });
    // Initial config card state
    showConfigCard(document.getElementById('authMethod').value);
    loadAuthConfig();
});
</script>
{% endblock %}