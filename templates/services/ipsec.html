{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}IPSec Configuration{% endblock %}

{% block content %}
<div id="ipsec-content">
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h4>IPSec Service Control</h4>
                </div>
                <div class="card-body">
                    <div class="btn-group w-100">
                        <button class="btn btn-primary" id="startIpsec">Start IPSec</button>
                        <button class="btn btn-warning" id="restartIpsec">Restart IPSec</button>
                        <button class="btn btn-danger" id="stopIpsec">Stop IPSec</button>
                        <button class="btn btn-secondary" id="reloadIpsec">Reload Config</button>
                    </div>
                    <div class="mt-3">
                        <h5>Service Status</h5>
                        <pre id="ipsecStatus">Loading...</pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="not-authorized" style="display:none;">{% include 'not_authorized.html' %}</div>
{% endblock %}

{% block extra_js %}
<script>
function loadIpsecStatus() {
    fetch('/api/services/ipsec/status/')
        .then(r => r.json())
        .then(data => {
            if (data.status) {
                document.getElementById('ipsecStatus').textContent = data.status;
            } else if (data.error) {
                if (data.error.includes('403')) {
                    document.getElementById('ipsec-content').style.display = 'none';
                    document.getElementById('not-authorized').style.display = '';
                } else {
                    document.getElementById('ipsecStatus').textContent = data.error;
                }
            }
        });
}
document.addEventListener('DOMContentLoaded', function() {
    loadIpsecStatus();
    document.getElementById('startIpsec').addEventListener('click', function() {
        fetch('/api/services/ipsec/control/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({action: 'start'})
        }).then(() => loadIpsecStatus());
    });
    document.getElementById('restartIpsec').addEventListener('click', function() {
        fetch('/api/services/ipsec/control/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({action: 'restart'})
        }).then(() => loadIpsecStatus());
    });
    document.getElementById('stopIpsec').addEventListener('click', function() {
        fetch('/api/services/ipsec/control/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({action: 'stop'})
        }).then(() => loadIpsecStatus());
    });
    document.getElementById('reloadIpsec').addEventListener('click', function() {
        fetch('/api/services/ipsec/control/', {
            method: 'POST',
            headers: {'X-CSRFToken': '{{ csrf_token }}'},
            body: new URLSearchParams({action: 'reload'})
        }).then(() => loadIpsecStatus());
    });
});
</script>
{% endblock %}