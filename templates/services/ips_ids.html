{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}IPS/IDS Configuration{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4>IPS/IDS Configuration</h4>
            </div>
            <div class="card-body">
                <form id="configForm" method="post">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="save_config">
                    {{ config_form|crispy }}
                    <button type="submit" class="btn btn-primary">Save Configuration</button>
                </form>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header">
                <h4>IPS/IDS Service Control</h4>
            </div>
            <div class="card-body">
                <div class="btn-group w-100">
                    <button class="btn btn-primary" id="startSnort">Start Service</button>
                    <button class="btn btn-warning" id="restartSnort">Restart Service</button>
                    <button class="btn btn-danger" id="stopSnort">Stop Service</button>
                </div>
                <div class="mt-3">
                    <h5>Service Status</h5>
                    <pre>{{ status }}</pre>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4>IPS/IDS Rules</h4>
            </div>
            <div class="card-body">
                <form id="addRuleForm">
                    <div class="row">
                        <div class="col">
                            <input type="text" class="form-control" id="ruleText" placeholder="Enter Snort rule text">
                        </div>
                        <div class="col-auto">
                            <button type="submit" class="btn btn-success">Add Rule</button>
                        </div>
                    </div>
                </form>
                <div class="table-responsive mt-3">
                    <table class="table table-striped" id="rulesTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Action</th>
                                <th>Protocol</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Message</th>
                                <th>Enabled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-header">
                <h4>IPS/IDS Alerts</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="alertsTable">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Priority</th>
                                <th>Source</th>
                                <th>Destination</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Rule Modal -->
<div class="modal fade" id="editRuleModal" tabindex="-1" aria-labelledby="editRuleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRuleModalLabel">Edit IPS/IDS Rule</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editRuleForm">
                <div class="modal-body">
                    <input type="hidden" id="editRuleId" name="rule_id">
                    <div class="mb-3">
                        <label for="editRuleText" class="form-label">Rule Text</label>
                        <input type="text" class="form-control" id="editRuleText" name="rule_text">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Rule</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
// Fetch and display rules
function loadRules() {
    fetch('/services/ips-ids/rules/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#rulesTable tbody');
            tbody.innerHTML = '';
            data.rules.forEach(rule => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${rule.sid || ''}</td>
                    <td>${rule.action || ''}</td>
                    <td>${rule.protocol || ''}</td>
                    <td>${rule.source || ''}</td>
                    <td>${rule.destination || ''}</td>
                    <td>${rule.message || ''}</td>
                    <td>${rule.enabled ? 'Yes' : 'No'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showEditRuleModal(${rule.sid}, '${rule.raw.replace(/'/g, "&#39;")}')">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.sid})">Delete</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        });
}

// Fetch and display alerts
function loadAlerts() {
    fetch('/services/ips-ids/alerts/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#alertsTable tbody');
            tbody.innerHTML = '';
            data.alerts.forEach(alert => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${alert.timestamp || ''}</td>
                    <td>${alert.priority || ''}</td>
                    <td>${alert.source || ''}</td>
                    <td>${alert.destination || ''}</td>
                    <td>${alert.message || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        });
}

// Add rule
const addRuleForm = document.getElementById('addRuleForm');
addRuleForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const ruleText = document.getElementById('ruleText').value;
    fetch('/services/ips-ids/rules/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ rule_text: ruleText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRules();
            addRuleForm.reset();
        } else {
            alert('Error adding rule: ' + (data.error || 'Unknown error'));
        }
    });
});

// Edit rule
function showEditRuleModal(sid, raw) {
    document.getElementById('editRuleId').value = sid;
    document.getElementById('editRuleText').value = raw;
    var modal = new bootstrap.Modal(document.getElementById('editRuleModal'));
    modal.show();
}

document.getElementById('editRuleForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const sid = document.getElementById('editRuleId').value;
    const ruleText = document.getElementById('editRuleText').value;
    fetch('/services/ips-ids/rules/', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sid: parseInt(sid), rule_text: ruleText })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRules();
            var modal = bootstrap.Modal.getInstance(document.getElementById('editRuleModal'));
            modal.hide();
        } else {
            alert('Error updating rule: ' + (data.error || 'Unknown error'));
        }
    });
});

// Delete rule
function deleteRule(sid) {
    if (!confirm('Are you sure you want to delete this rule?')) return;
    fetch('/services/ips-ids/rules/', {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sid: sid })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadRules();
        } else {
            alert('Error deleting rule: ' + (data.error || 'Unknown error'));
        }
    });
}

// Config form submit
const configForm = document.getElementById('configForm');
configForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(configForm);
    fetch('/services/ips-ids/', {
        method: 'POST',
        headers: { 'X-CSRFToken': formData.get('csrfmiddlewaretoken') },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Configuration saved and Snort restarted.');
        } else {
            alert('Error saving configuration: ' + (data.error || 'Unknown error'));
        }
    });
});

// Snort service operations
function snortService(action) {
    fetch('/services/ips-ids/', {
        method: 'POST',
        headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
        body: 'action=' + action
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            let actionText = '';
            if (action === 'start_snort') actionText = 'started';
            else if (action === 'stop_snort') actionText = 'stopped';
            else if (action === 'restart_snort') actionText = 'restarted';
            alert('IPS/IDS service ' + actionText + ' successfully');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
        }
    });
}
document.getElementById('startSnort').addEventListener('click', function() { snortService('start_snort'); });
document.getElementById('restartSnort').addEventListener('click', function() { snortService('restart_snort'); });
document.getElementById('stopSnort').addEventListener('click', function() { snortService('stop_snort'); });

// Initial load
loadRules();
loadAlerts();
setInterval(loadAlerts, 5000); // Refresh alerts every 5 seconds
</script>
{% endblock %}
{% endblock %}