{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Network Bonding{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Create Bond Interface</h4>
            </div>
            <div class="card-body">
                <form id="createBondForm" method="post" action="{% url 'network:bonding' %}" onsubmit="return handleFormSubmit(this);">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="create_bond">
                    <div class="mb-3">
                        {{ form.name|as_crispy_field }}
                    </div>
                    <div class="mb-3">
                        {{ form.mode|as_crispy_field }}
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.slaves.id_for_label }}" class="form-label">Slave Interfaces</label>
                        <div class="input-group">
                            <select name="{{ form.slaves.name }}" id="{{ form.slaves.id_for_label }}" 
                                    class="form-select" multiple size="5" required>
                                {% for value, label in form.slaves.field.choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary" onclick="selectAllSlaves()">Select All</button>
                        </div>
                        <div class="form-text">{{ form.slaves.help_text }}</div>
                        {% if form.slaves.errors %}
                            <div class="invalid-feedback d-block">
                                {{ form.slaves.errors }}
                            </div>
                        {% endif %}
                    </div>
                    <button type="submit" class="btn btn-primary" id="submitButton">Create Bond</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h4>Bond Interfaces</h4>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Interface</th>
                                <th>Mode</th>
                                <th>Slaves</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for bond in bonds %}
                            <tr>
                                <td>{{ bond.name }}</td>
                                <td>{{ bond.mode }}</td>
                                <td>{{ bond.slaves }}</td>
                                <td>
                                    <span class="badge bg-{% if bond.status == 'up' %}success{% else %}danger{% endif %}">
                                        {{ bond.status }}
                                    </span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editBondModal"
                                                data-bond-name="{{ bond.name }}"
                                                data-bond-mode="{{ bond.mode }}"
                                                data-bond-slaves="{{ bond.slaves }}">
                                            Edit
                                        </button>
                                        <button class="btn btn-danger delete-bond" data-bond-name="{{ bond.name }}">Delete</button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center">No bond interfaces configured</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4>Bonding Statistics</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Interface</th>
                        <th>Transmit</th>
                        <th>Receive</th>
                        <th>Slave Failures</th>
                        <th>Active Slave</th>
                    </tr>
                </thead>
                <tbody>
                    {% for stat in stats %}
                    <tr>
                        <td>{{ stat.interface }}</td>
                        <td>{{ stat.transmit }}</td>
                        <td>{{ stat.receive }}</td>
                        <td>{{ stat.failures }}</td>
                        <td>{{ stat.active }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">No bonding statistics available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Edit Bond Modal -->
<div class="modal fade" id="editBondModal" tabindex="-1" aria-labelledby="editBondModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editBondModalLabel">Edit Bond Interface</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editBondForm" method="post">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="form_type" value="edit_bond">
                    <input type="hidden" id="editBondName" name="bond_name">
                    {{ form|crispy }}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Update Bond</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
function selectAllSlaves() {
    const select = document.getElementById('{{ form.slaves.id_for_label }}');
    for (let option of select.options) {
        option.selected = true;
    }
}

function handleFormSubmit(form) {
    console.log('Form submission started...');
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;
    submitButton.innerHTML = 'Processing...';
    
    // Log form data
    const formData = new FormData(form);
    console.log('Form data:', Object.fromEntries(formData));
    
    // Submit the form using fetch
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        if (data.success) {
            alert(data.message || 'Bond interface created successfully');
            window.location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error occurred'));
            if (data.errors) {
                console.error('Form validation errors:', data.errors);
            }
        }
    })
    .catch(error => {
        console.error('Error submitting form:', error);
        alert('Error submitting form. Please check the console for details.');
    })
    .finally(() => {
        submitButton.disabled = false;
        submitButton.innerHTML = 'Create Bond';
    });
    
    return false; // Prevent default form submission
}

// Function to refresh bond status
function refreshBondStatus() {
    console.log('Refreshing bond status...');
    fetch(window.location.href, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Received data:', data);
        
        // Update bond interfaces table
        const tbody = document.querySelector('.table tbody');
        if (!tbody) {
            console.error('Could not find bond interfaces table body');
            return;
        }
        tbody.innerHTML = '';
        
        data.bonds.forEach(bond => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${bond.name}</td>
                <td>${bond.mode}</td>
                <td>${bond.slaves}</td>
                <td>
                    <span class="badge bg-${bond.status === 'up' ? 'success' : 'danger'}">
                        ${bond.status}
                    </span>
                </td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-primary" 
                                data-bs-toggle="modal" 
                                data-bs-target="#editBondModal"
                                data-bond-name="${bond.name}"
                                data-bond-mode="${bond.mode}"
                                data-bond-slaves="${bond.slaves}">
                            Edit
                        </button>
                        <button class="btn btn-danger delete-bond" data-bond-name="${bond.name}">Delete</button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        // Update statistics table
        const statsTbody = document.querySelectorAll('.table tbody')[1];
        if (!statsTbody) {
            console.error('Could not find statistics table body');
            return;
        }
        statsTbody.innerHTML = '';
        
        data.stats.forEach(stat => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${stat.interface}</td>
                <td>${stat.transmit}</td>
                <td>${stat.receive}</td>
                <td>${stat.failures}</td>
                <td>${stat.active}</td>
            `;
            statsTbody.appendChild(tr);
        });

        // Reattach event listeners
        attachEventListeners();
    })
    .catch(error => {
        console.error('Error refreshing bond status:', error);
    });
}

// Function to attach event listeners
function attachEventListeners() {
    console.log('Attaching event listeners...');
    // Delete bond event listeners
document.querySelectorAll('.delete-bond').forEach(button => {
    button.addEventListener('click', function() {
        const bondName = this.dataset.bondName;
        if (confirm(`Are you sure you want to delete bond interface ${bondName}?`)) {
            fetch(`/network/bonding/${bondName}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Bond interface deleted successfully');
                        refreshBondStatus();
                } else {
                    alert('Error deleting bond interface: ' + data.error);
                }
            })
            .catch(error => {
                alert('Error deleting bond interface: ' + error);
            });
        }
    });
});
}

// Initial event listener attachment
attachEventListeners();

// Set up periodic refresh
console.log('Setting up periodic refresh...');
setInterval(refreshBondStatus, 5000); // Refresh every 5 seconds

// Initial refresh
refreshBondStatus();

// Edit bond modal setup
document.getElementById('editBondModal').addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const modal = this;
    
    modal.querySelector('#editBondName').value = button.dataset.bondName;
    modal.querySelector('#id_name').value = button.dataset.bondName;
    modal.querySelector('#id_mode').value = button.dataset.bondMode;
    modal.querySelector('#id_slaves').value = button.dataset.bondSlaves;
});
</script>
{% endblock %}
{% endblock %}