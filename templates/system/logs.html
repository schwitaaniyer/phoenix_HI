{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}System Logs{% endblock %}

{% block content %}
<div class="card mb-4">
    <div class="card-header">
        <h2>System Logs</h2>
    </div>
    <div class="card-body">
        <div class="row mb-4">
            <div class="col-md-6">
                <form method="get">
                    <div class="input-group">
                        <input type="text" class="form-control" id="logSearch" placeholder="Search logs...">
                        <button class="btn btn-primary" type="button" id="searchLogs">Search</button>
                    </div>
                </form>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-danger" id="clearLogs">Clear Logs</button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Log Entry</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody">
                    <tr><td>Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h4>Running Processes</h4>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>PID</th>
                        <th>User</th>
                        <th>CPU %</th>
                        <th>Memory %</th>
                        <th>Name</th>
                    </tr>
                </thead>
                <tbody id="processes-tbody">
                    <tr><td colspan="5">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function loadLogs() {
    fetch('/api/logs/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('logs-tbody');
            tbody.innerHTML = '';
            (data.logs || []).forEach(log => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${log}</td>`;
                tbody.appendChild(tr);
            });
            if (!data.logs || data.logs.length === 0) {
                tbody.innerHTML = '<tr><td>No logs found.</td></tr>';
            }
        });
}
function loadProcesses() {
    fetch('/api/processes/')
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('processes-tbody');
            tbody.innerHTML = '';
            (data.processes || []).forEach(proc => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${proc.pid}</td>
                    <td>${proc.username}</td>
                    <td>${proc.cpu_percent}</td>
                    <td>${proc.memory_percent.toFixed(2)}</td>
                    <td>${proc.name}</td>
                `;
                tbody.appendChild(tr);
            });
            if (!data.processes || data.processes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">No processes found.</td></tr>';
            }
        });
}
document.addEventListener('DOMContentLoaded', function() {
    loadLogs();
    loadProcesses();
    document.getElementById('clearLogs').addEventListener('click', function() {
        if (confirm('Are you sure you want to clear all logs?')) {
            fetch('/system/clear-logs/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Logs cleared successfully');
                    loadLogs();
                } else {
                    alert('Error clearing logs: ' + data.error);
                }
            });
        }
    });
});
</script>
{% endblock %}